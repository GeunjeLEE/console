<template>
    <div class="p-data-loader">
        <div class="data-loader-container">
            <div v-show="(showDataFromScratch || dataLoadOccurred) && showEmptyCase" key="no-data" class="no-data-wrapper">
                <slot name="no-data">
                    {{ $t('COMPONENT.DATA_LOADER.NO_DATA') }}
                </slot>
            </div>

            <div v-show="(showDataFromScratch || dataLoadOccurred) && !showEmptyCase" key="data" class="data-wrapper">
                <slot />
            </div>

            <transition name="fade-in"
                        :appear-active-class="disableTransition ? 'fade-in-enter-to' : 'fade-in-enter-active'"
                        :enter-active-class="disableTransition ? 'fade-in-enter-to' : 'fade-in-enter-active'"
                        :leave-active-class="disableTransition ? 'fade-in-leave-to' : 'fade-in-leave-active'"
            >
                <div v-show="showLoader" key="loader" class="loader-wrapper"
                     :class="{'no-empty-case': disableEmptyCase && isEmpty}"
                >
                    <div class="loader-backdrop"
                         :style="{
                             opacity: loaderBackdropOpacity,
                             backgroundColor: loaderBackdropColor
                         }"
                    />
                    <div class="loader">
                        <slot name="loader">
                            <template v-if="loaderType === LOADER_TYPES.spinner">
                                <p-lottie name="thin-spinner" :size="spinnerSize"
                                          auto class="spinner"
                                />
                            </template>
                            <template v-else-if="loaderType === LOADER_TYPES.skeleton">
                                <p-skeleton class="skeleton" />
                            </template>
                        </slot>
                    </div>
                </div>
            </transition>
        </div>
    </div>
</template>

<script lang="ts">
import {
    computed, ComputedRef, defineComponent, PropType, reactive, toRefs, watch, WatchStopHandle,
} from '@vue/composition-api';
import { LOADER_TYPES } from '@/feedbacks/loading/data-loader/config';
import PLottie from '@/foundation/lottie/PLottie.vue';
import { i18n } from '@/translations';
import { isEmpty } from 'lodash';
import PSkeleton from '@/feedbacks/loading/skeleton/PSkeleton.vue';

interface Props {
    loading: boolean;
    data?: any;
    loaderType: LOADER_TYPES;
    disableEmptyCase: boolean;
    showDataFromScratch: boolean;
    minLoadingTime: number;
    lazyLoadingTime: number;
    loaderBackdropOpacity: number;
    loaderBackdropColor: string;
    disableTransition: boolean;
}
export default defineComponent<Props>({
    name: 'PDataLoader',
    components: { PSkeleton, PLottie },
    i18n,
    props: {
        loading: {
            type: Boolean,
            default: true,
        },
        data: {
            type: [Array, Object],
            default: undefined,
        },
        loaderType: {
            type: String as PropType<LOADER_TYPES>,
            default: LOADER_TYPES.spinner,
            validator(loaderType: LOADER_TYPES) {
                return Object.values(LOADER_TYPES).includes(loaderType);
            },
        },
        spinnerSize: {
            type: Number,
            default: 2.5,
        },
        disableEmptyCase: {
            type: Boolean,
            default: false,
        },
        showDataFromScratch: {
            type: Boolean,
            default: false,
        },
        minLoadingTime: {
            type: Number,
            default: 0,
            validator(minLoadingTime: number) {
                return minLoadingTime >= 0;
            },
        },
        lazyLoadingTime: {
            type: Number,
            default: 0,
            validator(lazyLoadingTime: number) {
                return lazyLoadingTime >= 0;
            },
        },
        loaderBackdropOpacity: {
            type: Number,
            default: 0.5,
        },
        loaderBackdropColor: {
            type: String,
            default: 'white',
        },
        disableTransition: {
            type: Boolean,
            default: false,
        },
    },
    setup(props) {
        const state = reactive({
            dataLoadOccurred: false,
            showEmptyCase: computed(() => !props.disableEmptyCase && state.isEmpty),
            isEmpty: computed(() => {
                if (!props.data) return false;
                if (Array.isArray(props.data)) return props.data.length === 0;
                return isEmpty(props.data);
            }),
            lazyLoading: props.loading,
            minLoading: props.loading,
            contextKey: Math.floor(Math.random() * Date.now()),
        });

        const registerLazyLoadingWatch = () => {
            let lazyLoadingHandler;
            watch(() => props.loading, (loading) => {
                if (loading) {
                    if (!state.dataLoadOccurred) {
                        state.lazyLoading = true;
                        return;
                    }

                    state.lazyLoading = false;

                    if (lazyLoadingHandler) clearTimeout(lazyLoadingHandler);
                    lazyLoadingHandler = setTimeout(() => {
                        state.lazyLoading = true;
                    }, props.lazyLoadingTime);
                } else {
                    if (lazyLoadingHandler) clearTimeout(lazyLoadingHandler);
                    state.lazyLoading = false;
                }
            }, { immediate: true });

            if (props.minLoadingTime) {
                let minLoadingHandler;
                watch(() => state.lazyLoading, (lazyLoading) => {
                    if (lazyLoading) {
                        state.minLoading = true;

                        if (minLoadingHandler) clearTimeout(minLoadingHandler);
                        minLoadingHandler = setTimeout(() => {
                            state.minLoading = false;
                        }, props.minLoadingTime);
                    }
                }, { immediate: true });
            }
        };

        const registerMinLoadingWatch = () => {
            let minLoadingHandler;
            watch(() => props.loading, (loading) => {
                if (loading) {
                    state.minLoading = true;

                    if (minLoadingHandler) clearTimeout(minLoadingHandler);
                    minLoadingHandler = setTimeout(() => {
                        state.minLoading = false;
                    }, props.minLoadingTime);
                }
            }, { immediate: true });
        };


        let showLoader: ComputedRef<boolean>;
        if (props.lazyLoadingTime) {
            if (props.minLoadingTime) showLoader = computed<boolean>(() => state.minLoading || state.lazyLoading);
            else showLoader = computed<boolean>(() => state.lazyLoading);
            registerLazyLoadingWatch();
        } else if (props.minLoadingTime) {
            showLoader = computed<boolean>(() => state.minLoading || props.loading);
            registerMinLoadingWatch();
        } else showLoader = computed<boolean>(() => props.loading);


        let stopDataLoadCheckWatch: WatchStopHandle;
        // CAUTION: Do not make stopDataLoadCheckWatch as const variable. Related issue: https://github.com/webpack/webpack/issues/12724
        // eslint-disable-next-line prefer-const
        stopDataLoadCheckWatch = watch(() => showLoader.value, (loading) => {
            if (!loading) {
                state.dataLoadOccurred = true;
                if (stopDataLoadCheckWatch) stopDataLoadCheckWatch();
            }
        }, { immediate: true });

        return {
            LOADER_TYPES,
            ...toRefs(state),
            showLoader,
        };
    },
});
</script>

<style lang="postcss">
.p-data-loader {
    @apply w-full;
    .data-loader-container {
        @apply relative w-full h-full overflow-hidden;
        min-height: inherit;

        /* transitions */
        > .fade-in-enter-active {
            transition: opacity 0s;
        }
        > .fade-in-leave-active {
            transition: opacity 0.2s;
        }
        > .fade-in-enter, > .fade-in-leave-to {
            opacity: 0;
        }
        > .fade-in-leave, > .fade-in-enter-to {
            opacity: 1;
        }
    }
    .loader-wrapper {
        @apply absolute w-full h-full overflow-hidden;
        &.no-empty-case {
            @apply static;
        }
        top: 0;
        z-index: 1;
        .loader-backdrop {
            @apply w-full h-full;
        }
        .loader {
            @apply absolute flex w-full h-full justify-center items-center;
            top: 0;
            z-index: 1;
            .spinner {
                max-height: 16.875rem;
            }
            .skeleton {
                height: 100%;
            }
        }
    }

    .no-data-wrapper {
        @apply justify-center items-center flex w-full text-gray-300 text-center;
        line-height: 120%;
        font-size: 1rem;
        height: calc(100% - 2rem);
        max-height: 16.875rem;
        min-height: inherit;
    }

    .data-wrapper {
        @apply overflow-y-auto h-full;
    }
}
</style>
